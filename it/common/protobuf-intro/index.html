<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <html lang="en"></html>
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-128207704-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <title>比較 JSON 和 protobuf 並介紹 protobuf編碼、語法及 protobuf over HTTP 示例 | 不輟集</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Protocol Buffers（簡稱 protobuf），是 Google 推出的一種數據交換格式，採用 Varint 和 ZigZag 等二進制編碼，數據壓縮效果顯著，可用來傳輸數據或持久化數據。 JSON 是什麼？JSON 全稱爲 JavaScript Object Notation（JavaScript對象標記），即 JS對象的字符串表示。其採用文本編碼，是現今最通用的數據交換格式。200">
<meta property="og:type" content="article">
<meta property="og:title" content="比較 JSON 和 protobuf 並介紹 protobuf編碼、語法及 protobuf over HTTP 示例">
<meta property="og:url" content="https://blog.tsunhualim.top/it/common/protobuf-intro/index.html">
<meta property="og:site_name" content="不輟集">
<meta property="og:description" content="Protocol Buffers（簡稱 protobuf），是 Google 推出的一種數據交換格式，採用 Varint 和 ZigZag 等二進制編碼，數據壓縮效果顯著，可用來傳輸數據或持久化數據。 JSON 是什麼？JSON 全稱爲 JavaScript Object Notation（JavaScript對象標記），即 JS對象的字符串表示。其採用文本編碼，是現今最通用的數據交換格式。200">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://blog.tsunhualim.top/it/common/protobuf-intro/w644.jpeg">
<meta property="og:image" content="https://blog.tsunhualim.top/it/common/protobuf-intro/protobuf-field-structure.jpeg">
<meta property="article:published_time" content="2021-11-21T06:12:51.000Z">
<meta property="article:modified_time" content="2025-08-27T11:25:43.456Z">
<meta property="article:author" content="Hua">
<meta property="article:tag" content="代碼家">
<meta property="article:tag" content="protobuf">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.tsunhualim.top/it/common/protobuf-intro/w644.jpeg">
  
  
    <link rel="shortcut icon" href="favicon.ico" />
  
  
  
    <link href="//fonts.font.im/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="不輟集" type="application/atom+xml">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">不輟集</a>
      </h1>
      
      <h2 id="subtitle-wrap">
        <a href="/" id="subtitle">Keep Yourself Alive</a>
      </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          
            <a class="main-nav-link" href="/">頭頁</a>
          
        
          
            <a class="main-nav-link" target="_blank" rel="noopener" href="https://hokkien-writing.github.io/">閩南語書寫</a>
          
        
          
            <a class="main-nav-link" href="/atom.xml">RSS</a>
          
        
          
            <a class="main-nav-link" target="_blank" rel="noopener" href="https://github.com/tsunhua">GitHub</a>
          
        
      </nav>
      <!-- <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
        <a class="main-nav-link" href="/">頭頁</a>
        
        <a class="main-nav-link" target="_blank" rel="noopener" href="https://hokkien-writing.github.io/">閩南語書寫</a>
        
        <a class="main-nav-link" href="/atom.xml">RSS</a>
        
        <a class="main-nav-link" target="_blank" rel="noopener" href="https://github.com/tsunhua">GitHub</a>
        
      </nav> -->
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="搜尋"></a>
      </nav>
      <div id="search-form-wrap">
        <div class="search-form">
          <input type="search" id="local-search-input" name="q" results="0" placeholder="搜尋"
            class="search-form-input" />
        </div>
      </div>
    </div>

    <div id="local-search-result" class="local-search-result-cls"></div>

  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-it/common/protobuf-intro" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/it/common/protobuf-intro/" class="article-date">
  <time datetime="2021-11-21T06:12:51.000Z" itemprop="datePublished">2021-11-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      比較 JSON 和 protobuf 並介紹 protobuf編碼、語法及 protobuf over HTTP 示例
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
          <div id="toc" class="toc-article">
              <strong class="toc-title">目錄</strong>
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#JSON-%E6%98%AF%E4%BB%80%E9%BA%BC%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">JSON 是什麼？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#protobuf-%E6%98%AF%E4%BB%80%E9%BA%BC%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">protobuf 是什麼？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%96%8B%E5%A7%8B%E4%BD%BF%E7%94%A8-protobuf"><span class="toc-number">3.</span> <span class="toc-text">開始使用 protobuf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JSON-%E5%92%8C-protobuf-%E7%9A%84%E7%B7%A8%E7%A2%BC%E5%A4%A7%E4%B8%8D%E5%90%8C"><span class="toc-number">4.</span> <span class="toc-text">JSON 和 protobuf 的編碼大不同</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Varint-%E7%B7%A8%E7%A2%BC"><span class="toc-number">4.1.</span> <span class="toc-text">Varint 編碼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#protobuf-%E7%B7%A8%E7%A2%BC%E8%A6%8F%E5%89%87"><span class="toc-number">4.2.</span> <span class="toc-text">protobuf 編碼規則</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E8%AE%80%E5%BA%8F%E5%88%97-086c-1205-446fb6b79"><span class="toc-number">4.3.</span> <span class="toc-text">解讀序列 086c 1205 446fb6b79</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZigZag-%E7%B7%A8%E7%A2%BC"><span class="toc-number">4.4.</span> <span class="toc-text">ZigZag 編碼</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#proto3-%E8%AA%9E%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">proto3 語法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#proto-%E9%A2%A8%E6%A0%BC"><span class="toc-number">5.1.</span> <span class="toc-text">proto 風格</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E9%81%A9%E7%94%A8-protobuf-%E7%9A%84%E6%83%85%E6%B3%81"><span class="toc-number">6.</span> <span class="toc-text">不適用 protobuf 的情況</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%8F%E7%AD%94"><span class="toc-number">7.</span> <span class="toc-text">問答</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%82%BA%E4%BB%80%E9%BA%BC-protobuf-%E5%8F%AB-protobuf%EF%BC%9F"><span class="toc-number">7.1.</span> <span class="toc-text">為什麼 protobuf 叫 protobuf？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#protobuf-%E6%98%AF%E5%90%A6%E5%8F%AF%E4%BB%A5%E5%9C%A8-HTTP-%E4%B8%AD%E4%BD%BF%E7%94%A8%EF%BC%9F"><span class="toc-number">7.2.</span> <span class="toc-text">protobuf 是否可以在 HTTP 中使用？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9AHTTP-over-protobuf"><span class="toc-number">7.3.</span> <span class="toc-text">示例：HTTP over protobuf</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Go-%E6%9C%8D%E5%8B%99%E7%AB%AF"><span class="toc-number">7.3.1.</span> <span class="toc-text">Go 服務端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Java-%E6%9C%8D%E5%8B%99%E7%AB%AF"><span class="toc-number">7.3.2.</span> <span class="toc-text">Java 服務端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%96%B1%E8%AE%80%E6%9B%B4%E5%A4%9A"><span class="toc-number">8.</span> <span class="toc-text">閱讀更多</span></a></li></ol>
          </div>
        
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Protocol Buffers<code>（簡稱 protobuf）</code>，是 Google 推出的一種數據交換格式，採用 Varint 和 ZigZag 等二進制編碼，數據壓縮效果顯著，可用來傳輸數據或持久化數據。</p>
<h2 id="JSON-是什麼？"><a href="#JSON-是什麼？" class="headerlink" title="JSON 是什麼？"></a>JSON 是什麼？</h2><p>JSON 全稱爲 JavaScript Object Notation<code>（JavaScript對象標記）</code>，即 JS對象的字符串表示。其採用文本編碼，是現今最通用的數據交換格式。2001年3月，State Software公司的聯合創始人設計了此種格式，並隨後進行了標準化。現在有 ECMA-404（2013年）和 RFC-8259（2017年）兩種標準。</p>
<h2 id="protobuf-是什麼？"><a href="#protobuf-是什麼？" class="headerlink" title="protobuf 是什麼？"></a>protobuf 是什麼？</h2><p>protobuf 全稱爲 Protocol Buffers<code>（“協議緩衝”）</code>，是一種數據壓縮性能優秀的數據存儲和交換格式。其採用二進制編碼，通常跟 gRPC 一起使用。</p>
<p>2001年 Google公司內部誕生了proto1版本，並隨後在2008年以BSD協議開源了proto2，2016年釋出proto3正式版。</p>
<p>對於 proto2，官方推出了針對 C++、Java、C# 和 Python 語言的 protobuf編譯器 protoc；而在 proto3 中，增加了對 Dart、GO、Kotlin 和 Ruby 的官方支持。另外，第三方有提供對 JavaScript 和 PHP 等等語言的支持。</p>
<span id="more"></span>

<h2 id="開始使用-protobuf"><a href="#開始使用-protobuf" class="headerlink" title="開始使用 protobuf"></a>開始使用 protobuf</h2><p>（1）下載編譯器並設置環境變量。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># protoc</span></span><br><span class="line">PB_REL=<span class="string">&quot;https://github.com/protocolbuffers/protobuf/releases&quot;</span></span><br><span class="line">curl -LO <span class="variable">$PB_REL</span>/download/v3.15.8/protoc-3.15.8-osx-x86_64.zip</span><br><span class="line">unzip protoc-3.15.8-osx-x86_64.zip -d ~/go/bin/protoc-3.15.8</span><br><span class="line"><span class="built_in">cp</span> ~/go/bin/protoc-3.15.8/bin/protoc ~/go/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># protoc-gen-go 和 protoc-gen-go-grpc</span></span><br><span class="line">go get google.golang.org/protobuf/cmd/protoc-gen-go \</span><br><span class="line">   google.golang.org/grpc/cmd/protoc-gen-go-grpc</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PATH</span>:<span class="subst">$(go env GOPATH)</span>/bin&quot;</span></span><br></pre></td></tr></table></figure>

<p>（2）選擇使用 proto2 還是 proto3，不同的版本有不同的語法，且不兼容。相對而言，proto3 的語法更簡單。</p>
<p>（3）根據語法編寫 proto 文件。</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;/pb&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> java_package = <span class="string">&quot;com.example.m.pb&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">&quot;AnimalProto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> pb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Animal</span>&#123;</span><br><span class="line">  <span class="comment">// reserved 1 to 10;</span></span><br><span class="line">  <span class="comment">// reserved &quot;id&quot;;</span></span><br><span class="line">  <span class="type">int64</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（4）生成需要的語言代碼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">protoc --go_out=.  animal.proto</span><br></pre></td></tr></table></figure>

<p>生成後的文件 animal.pb.go 如下：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Code generated by protoc-gen-go. DO NOT EDIT.</span></span><br><span class="line"><span class="comment">// versions:</span></span><br><span class="line"><span class="comment">//   protoc-gen-go v1.27.1</span></span><br><span class="line"><span class="comment">//   protoc        v3.15.8</span></span><br><span class="line"><span class="comment">// source: animal.proto</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> pb</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  protoreflect <span class="string">&quot;google.golang.org/protobuf/reflect/protoreflect&quot;</span></span><br><span class="line">  protoimpl <span class="string">&quot;google.golang.org/protobuf/runtime/protoimpl&quot;</span></span><br><span class="line">  reflect <span class="string">&quot;reflect&quot;</span></span><br><span class="line">  sync <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  <span class="comment">// Verify that this generated code is sufficiently up-to-date.</span></span><br><span class="line">  _ = protoimpl.EnforceVersion(<span class="number">20</span> - protoimpl.MinVersion)</span><br><span class="line">  <span class="comment">// Verify that runtime/protoimpl is sufficiently up-to-date.</span></span><br><span class="line">  _ = protoimpl.EnforceVersion(protoimpl.MaxVersion - <span class="number">20</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Animal <span class="keyword">struct</span> &#123;</span><br><span class="line">  state         protoimpl.MessageState</span><br><span class="line">  sizeCache     protoimpl.SizeCache</span><br><span class="line">  unknownFields protoimpl.UnknownFields</span><br><span class="line"></span><br><span class="line">  Id   <span class="type">int64</span>  <span class="string">`protobuf:&quot;varint,1,opt,name=id,proto3&quot; json:&quot;id,omitempty&quot;`</span></span><br><span class="line">  Name <span class="type">string</span> <span class="string">`protobuf:&quot;bytes,2,opt,name=name,proto3&quot; json:&quot;name,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="JSON-和-protobuf-的編碼大不同"><a href="#JSON-和-protobuf-的編碼大不同" class="headerlink" title="JSON 和 protobuf 的編碼大不同"></a>JSON 和 protobuf 的編碼大不同</h2><p>我們舉一個例子來說明會比較直觀。</p>
<p><img src="/it/common/protobuf-intro/w644.jpeg" alt="柯基犬"></p>
<p>這是一隻柯基犬，它叫 Dokky，編號 12。我們可以將這些信息結構化成對象如下：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Animal <span class="keyword">struct</span>&#123;</span><br><span class="line">    Id      <span class="type">int64</span>   <span class="comment">// 12</span></span><br><span class="line">    Name    <span class="type">string</span>  <span class="comment">// &quot;Dokky&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>編寫程序分別對該 Animal 進行 JSON 和 protobuf 序列化：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">marshal</span><span class="params">()</span></span> &#123;</span><br><span class="line">  dokky := pb.Animal&#123;</span><br><span class="line">    Id:   <span class="number">12</span>,</span><br><span class="line">    Name: <span class="string">&quot;Dokky&quot;</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pbs, _ := proto.Marshal(&amp;dokky)</span><br><span class="line">  printBytes(pbs)</span><br><span class="line"></span><br><span class="line">  jbs, _ := json.Marshal(&amp;dokky)</span><br><span class="line">  printBytes(jbs)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printBytes</span><span class="params">(bs []<span class="type">byte</span>)</span></span> &#123;</span><br><span class="line">  <span class="built_in">println</span>(<span class="built_in">len</span>(bs), hex.EncodeToString(bs))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>結果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">9 080c1205446f6b6b79</span><br><span class="line">24 7b226964223a31322c226e616d65223a22446f6b6b79227d</span><br></pre></td></tr></table></figure>

<p><strong>（1）JSON 序列化</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Dokky&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>二進制形式（Unicode編碼）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">7b</span><br><span class="line">    22 6964 22 3a 3132 2c</span><br><span class="line">    22 6e616d65 22 3a 22 446f6b6b79 22</span><br><span class="line">7d</span><br></pre></td></tr></table></figure>

<p>共佔用 24 個字節。</p>
<p><strong>（2）protobuf 序列化</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">086c 1205 446fb6b79</span><br></pre></td></tr></table></figure>

<p>共佔用 9 個字節。</p>
<p>通過輸出的結果簡單對比兩種序列化方式可見，protobuf</p>
<ol>
<li>不編碼變量名；</li>
<li>沒有額外的 <code>&#123;&#125;[],:&quot;&quot;</code> 等字符；</li>
<li>對整型不使用文本編碼。</li>
</ol>
<p>要具體解讀這串序列，我們還得先來了解下 protobuf 的編碼方式。</p>
<h3 id="Varint-編碼"><a href="#Varint-編碼" class="headerlink" title="Varint 編碼"></a>Varint 編碼</h3><p>Varint 即 Variable int，可變長整型編碼，是 protobuf 中最主要的編碼方式。其採用小端二進制編碼，即 LSB<code>（Least Significant Bit，最低有效位）</code>置於低地址。每個字節的首位即 MSB<code>（Most Significant Bit，最高有效位）</code>用來標識下個字節是否需要讀取， 1 表示需要，0 反之。</p>
<p>以數字 12 為例（爲簡便起見，假定類型爲 int16）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">      二進制序列：0000 0000 0000 1100</span><br><span class="line">從末尾開始7位一組： 000 1100</span><br><span class="line">        添加MSB：0000 1100</span><br><span class="line">    十六進制表示：0C</span><br></pre></td></tr></table></figure>

<p>再以數字 255 為例（爲簡便起見，假定類型爲 int16）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">      二進制序列：0000 0000 1111 1110</span><br><span class="line">從末尾開始7位一組： 111 1110  000 0001</span><br><span class="line">        添加MSB：1111 1110 0000 0001</span><br><span class="line">    十六進制表示：FE01</span><br></pre></td></tr></table></figure>

<h3 id="protobuf-編碼規則"><a href="#protobuf-編碼規則" class="headerlink" title="protobuf 編碼規則"></a>protobuf 編碼規則</h3><p>一般來說，在protobuf 中每個字段拆分成四個部分進行編碼，依次是：</p>
<p><img src="/it/common/protobuf-intro/protobuf-field-structure.jpeg" alt="protobuf 字段結構"></p>
<ol>
<li>number：字段序號；</li>
<li>type：字段類型，佔用 3 個比特位，與 number 一起構成字段標識 tag，佔用一個或多個字節，採用 Varint 編碼；其取值含義見下表；</li>
<li>length（可選）：字段長度，當 type 爲 2 時有值；</li>
<li>value：字段值，爲零值的字段不會進行編碼。</li>
</ol>
<table>
<thead>
<tr>
<th>Type</th>
<th>Meaning</th>
<th>Used for</th>
</tr>
</thead>
<tbody><tr>
<td>0（000）</td>
<td>Varint（可變長整型）</td>
<td>int32、int64、uint32、uint64、sint32、sint64、bool、enum</td>
</tr>
<tr>
<td>1（001）</td>
<td>64-bit（固定64位）</td>
<td>fixed64、sfixed64、double</td>
</tr>
<tr>
<td>2（010）</td>
<td>Length-delimited（指定長度）</td>
<td>string、bytes、embedded message、packed repeated fields</td>
</tr>
<tr>
<td>5（101）</td>
<td>32-bit（固定32位）</td>
<td>fixed32、sfixed32、float</td>
</tr>
</tbody></table>
<h3 id="解讀序列-086c-1205-446fb6b79"><a href="#解讀序列-086c-1205-446fb6b79" class="headerlink" title="解讀序列 086c 1205 446fb6b79"></a>解讀序列 086c 1205 446fb6b79</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="number">08</span> =&gt; <span class="number">00001</span> <span class="number">000</span> =&gt; <span class="attr">number</span>: <span class="number">1</span>, <span class="attr">type</span>: <span class="number">0</span></span><br><span class="line">0C =&gt; <span class="attr">value</span>: <span class="number">12</span></span><br></pre></td></tr></table></figure>

<p>序號爲 1 的字段，類型爲 Varint，值爲 12。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="number">12</span> =&gt; <span class="number">00010</span> <span class="number">010</span> =&gt; <span class="attr">number</span>: <span class="number">2</span>, <span class="attr">type</span>: <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">05</span> =&gt; <span class="attr">length</span>: <span class="number">5</span></span><br><span class="line"></span><br><span class="line">446fb6b79 =&gt; <span class="attr">value</span>: <span class="title class_">Dokky</span></span><br></pre></td></tr></table></figure>

<p>序號爲 2 的字段，類型爲 Length-delimited，值爲 Dokky。</p>
<h3 id="ZigZag-編碼"><a href="#ZigZag-編碼" class="headerlink" title="ZigZag 編碼"></a>ZigZag 編碼</h3><p>前面我們討論了非負數的 Varint 編碼，現在我們來看看負數。其實對於負數，並不建議使用 int32 或 int64 等類型，而應使用 sint32 或 sint64，即帶符號的整型。為什麼呢？下面我們對 -1 分別指定 int 32 和 sint32 類型進行編碼：</p>
<p><strong>（1）int32(-1)</strong></p>
<p>使用 int32 或 int64 類型時，進行 Varint 編碼，負數總是佔用 10 個字節。因此 int32(-1) 編碼爲：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">      二進制序列：11111111  11111111  11111111  11111111</span><br><span class="line">                11111111  11111111  11111111  11111111</span><br><span class="line">從尾部開始7位一組： 1111111   1111111   1111111   1111111</span><br><span class="line">                 1111111   1111111   1111111   1111111  1111111 0000001</span><br><span class="line">        添加MSB：11111111  11111111  11111111  11111111</span><br><span class="line">                11111111  11111111  11111111  11111111  11111111 00000001</span><br><span class="line">    十六進制表示：FF FF FF FF</span><br><span class="line">                FF FF FF FF FF 01</span><br></pre></td></tr></table></figure>

<p><strong>（2）sint32(-1)</strong></p>
<p>當使用 sint32 或 sint64 時，會先進行 ZigZag 編碼再進行 Varint 編碼。ZigZag 就是將負數放到整數前面，交替進行編碼，呈“Z” 或 “之” 字形，故有此稱。</p>
<p>對 sint32， 數字 n 的 ZigZag 編碼爲：(n &lt;&lt; 1) ^ (n &gt;&gt; 31)</p>
<p>對 sint64， 數字 n 的 ZigZag 編碼爲：(n &lt;&lt; 1) ^ (n &gt;&gt; 63)</p>
<p>因此 sint32(-1) 編碼爲：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">      二進制序列： 11111111  11111111  11111111  11111111</span><br><span class="line">        n &lt;&lt; 1： 11111111  11111111  11111111  11111110</span><br><span class="line">       n &gt;&gt; 31： 11111111  11111111  11111111  11111111</span><br><span class="line">           異或： 00000000  00000000  00000000   00000001</span><br><span class="line">從尾部開始7位一組：   0000001</span><br><span class="line">        添加MSB： 00000001</span><br><span class="line">    十六進制表示： 01</span><br></pre></td></tr></table></figure>

<p>可見，int32(-1) 佔用 10 個字節，而 sint32(-1)  佔用 1 個字節。在值可能爲負數的情況下，應使用帶符號整型，可以大大減少負數的編碼量。</p>
<h2 id="proto3-語法"><a href="#proto3-語法" class="headerlink" title="proto3 語法"></a>proto3 語法</h2><figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 指定使用的語言版本</span></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定生成文件的 Go 包路徑，使用 &#x27;/&#x27; 分隔</span></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;/pb&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定生成文件的 Java 包路徑，使用 &#x27;.&#x27; 分隔</span></span><br><span class="line"><span class="keyword">option</span>  java_package = <span class="string">&quot;com.example.m.pb&quot;</span>;</span><br><span class="line"><span class="comment">// 定義生成文件的 Java 類名</span></span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">&quot;AnimalProto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定包名</span></span><br><span class="line"><span class="keyword">package</span> pb;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定義一個名為 Animal 的消息</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Animal</span>&#123;</span><br><span class="line">  <span class="comment">// 定義一個名為 id 的 int64 字段</span></span><br><span class="line">  <span class="type">int64</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 定義一個名為 name 的 string 字段</span></span><br><span class="line">  <span class="type">string</span> name = <span class="number">2</span>;</span><br><span class="line">  <span class="comment">// 保留第3～5的字段序號</span></span><br><span class="line">  reserved <span class="number">3</span> to <span class="number">5</span>;</span><br><span class="line">  <span class="comment">// 保留字段名 kind</span></span><br><span class="line">  reserved <span class="string">&quot;kind&quot;</span>;</span><br><span class="line">  <span class="comment">// 使用 enum 類型</span></span><br><span class="line">  Vision vision = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 以下字段的值只允許是 HumanDifference 或 OtherAnimalDifference</span></span><br><span class="line">  <span class="comment">// 設置其中一個值將會清除另一個的值</span></span><br><span class="line">  <span class="keyword">oneof</span> difference&#123;</span><br><span class="line">    <span class="comment">// 使用自定義的結構類型</span></span><br><span class="line">    HumanDifference human = <span class="number">8</span>;</span><br><span class="line">    OtherAnimalDifference other = <span class="number">9</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定義一個枚舉類型，按風格要求第一個值須設置為未指定</span></span><br><span class="line"><span class="keyword">enum </span><span class="title class_">Vision</span>&#123;</span><br><span class="line">  VISION_UNSPECSIFIED = <span class="number">0</span>;</span><br><span class="line">  VISION_GREAT = <span class="number">1</span>;</span><br><span class="line">  VISION_BURRED = <span class="number">2</span>;</span><br><span class="line">  VISION_BLIND = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HumanDifference</span>&#123;</span><br><span class="line">  <span class="comment">// 定義一個名為 lang 的 string 數組</span></span><br><span class="line">  <span class="keyword">repeated</span> <span class="type">string</span> langs = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">OtherAnimalDifference</span>&#123;</span><br><span class="line">  <span class="comment">// 字段名採用全小寫下划線連接</span></span><br><span class="line">  <span class="keyword">repeated</span> <span class="type">string</span> natural_enemies = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ol>
<li>建议将变量序号 1～15 的给最常用的字段用，并保留扩展；</li>
<li>message 可以导入；</li>
<li>字段有默认零值，零值不会被序列化；</li>
<li>字段序號一旦指定，一般不改動，否則會向後不兼容。</li>
<li>當值為 1～128（2^7） 時使用 int32 類型僅用 1 個字節，當值為 129～2^14 時僅用 2 個字節；</li>
<li>對大於 2^28 的數，需要用到 5 個字節及以上的空間，這時候使用 fixed32 或 fixed64 更為划算。</li>
</ol>
<p>proto3 定義了以下的標量類型<code>（Scalar Type, hold one value at a time）</code>：</p>
<table>
<thead>
<tr>
<th>Scalar Type</th>
<th>Meaning</th>
<th>Go Type</th>
<th>Java/Kotlin Type</th>
</tr>
</thead>
<tbody><tr>
<td>double</td>
<td>雙精度浮點型</td>
<td>float64</td>
<td>double</td>
</tr>
<tr>
<td>float</td>
<td>浮點型</td>
<td>float</td>
<td>float</td>
</tr>
<tr>
<td>int32</td>
<td>使用Varint編碼的32位整型</td>
<td>int32</td>
<td>int</td>
</tr>
<tr>
<td>int64</td>
<td>使用Varint編碼的64位整型</td>
<td>int64</td>
<td>long</td>
</tr>
<tr>
<td>uint32</td>
<td>使用Varint編碼的無符號32位整型</td>
<td>uint32</td>
<td>long</td>
</tr>
<tr>
<td>uint64</td>
<td>使用Varint編碼的無符號64位整型</td>
<td>uint64</td>
<td>long</td>
</tr>
<tr>
<td>sint32</td>
<td>使用Varint編碼的有符號32位整型</td>
<td>int32</td>
<td>int</td>
</tr>
<tr>
<td>sint64</td>
<td>使用Varint編碼的有符號64位整型</td>
<td>int64</td>
<td>long</td>
</tr>
<tr>
<td>fixed32</td>
<td>固定32位的整型</td>
<td>uint32</td>
<td>int</td>
</tr>
<tr>
<td>fixed64</td>
<td>固定64位的整型</td>
<td>uint64</td>
<td>long</td>
</tr>
<tr>
<td>sfixed32</td>
<td>固定長度的有符號32位整型</td>
<td>int32</td>
<td>int</td>
</tr>
<tr>
<td>sfixed64</td>
<td>固定長度的有符號64位整型</td>
<td>int64</td>
<td>long</td>
</tr>
<tr>
<td>bool</td>
<td>布爾型</td>
<td>bool</td>
<td>boolean</td>
</tr>
<tr>
<td>string</td>
<td>採用UTF-8或者7位ASCII碼編碼的字符串</td>
<td>string</td>
<td>String</td>
</tr>
<tr>
<td>bytes</td>
<td>字節序列</td>
<td>[]byte</td>
<td>ByteString</td>
</tr>
</tbody></table>
<h3 id="proto-風格"><a href="#proto-風格" class="headerlink" title="proto 風格"></a>proto 風格</h3><ol>
<li>文件名、字段名建議使用全小寫字母加下划線<code>（lower_snake_case）</code>；</li>
<li>每行長度限定在 80 個字符；</li>
<li>使用 2 個空格作為縮緊；</li>
<li>字符串使用雙引號包裹；</li>
<li>repeated 類型的字段名使用複數形式；</li>
<li>enum 類型第一個枚舉值建議以 UNSPECIFIED 為後綴標明為「未指定值」，值為 0；</li>
<li>RPC 服務名及方法名採用大駝峰。</li>
</ol>
<h2 id="不適用-protobuf-的情況"><a href="#不適用-protobuf-的情況" class="headerlink" title="不適用 protobuf 的情況"></a>不適用 protobuf 的情況</h2><ol>
<li>目前官方僅支持 C++、C#、Dart、Go、Java、Kotlin、Python 和 Ruby，其它語言有的有第三方支持，需慎重考慮；</li>
<li>傳輸超過 1MB 的 message 時建議另擇策略，protobuf 並非爲大數據集而設計；</li>
<li>當枚舉值的零值在應用中有特殊含義時，不應使用 protobuf 中的 enum，因 protobuf 中的 enum 默認零值只應該是未指定的意思；</li>
<li>需要使用到 protobuf 中未定義或不完善的類型時。</li>
</ol>
<h2 id="問答"><a href="#問答" class="headerlink" title="問答"></a>問答</h2><h3 id="為什麼-protobuf-叫-protobuf？"><a href="#為什麼-protobuf-叫-protobuf？" class="headerlink" title="為什麼 protobuf 叫 protobuf？"></a>為什麼 protobuf 叫 protobuf？</h3><p>Protocol 即協議，指的是商定的消息協議或者說消息格式，它存放在 proto 文件中。</p>
<p>而 Buffers 呢？</p>
<p>在早期的實現中並沒有編譯器自動生成類，而是有一個名為 ProtocolBuffer 的類實現了一個 Buffer，用戶通過 AddValue(tag, value) 方法添加 tag/value 對（以原始字節方式存儲）到 Buffer中，然後再讀取出來。這個 tag 其實是用來標示字段序號和類型，value 則是編碼後的字段值。</p>
<p>這個 Buffer 在新的版本中已經不在，但名稱保留下來了。</p>
<h3 id="protobuf-是否可以在-HTTP-中使用？"><a href="#protobuf-是否可以在-HTTP-中使用？" class="headerlink" title="protobuf 是否可以在 HTTP 中使用？"></a>protobuf 是否可以在 HTTP 中使用？</h3><p>gRPC 基於 HTTP2 二進制協議，比 HTTP 文本協議傳輸數據量小；而且長連接，減少建立連接的消耗。protobuf 是一種二進制的數據交換格式，序列化後傳輸的數據量很小，可以說 protobuf + gRPC 結合很登對。</p>
<p>通常 JSON + HTTP 在上層應用中很流行，JSON 是一種文本型的數據交換格式，易讀，簡單地將對象轉為 JSON 字符串，然後再以其二進制形式傳輸即可。</p>
<p>但其實 protobuf 是可以在 HTTP 協議中運用的，使用 Content-Type 為 application/x-protobuf，將使用 proto 序列化後的二進制流傳輸到客戶端，客戶端再使用 proto 的反序列化方法解析即可。</p>
<h3 id="示例：HTTP-over-protobuf"><a href="#示例：HTTP-over-protobuf" class="headerlink" title="示例：HTTP over protobuf"></a>示例：HTTP over protobuf</h3><h4 id="Go-服務端"><a href="#Go-服務端" class="headerlink" title="Go 服務端"></a>Go 服務端</h4><p>server.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;example.com/m/pb&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">  <span class="string">&quot;google.golang.org/protobuf/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  s := gin.Default()</span><br><span class="line">  s.GET(<span class="string">&quot;/whoami&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    animal := pb.Animal&#123;</span><br><span class="line">      Id:   <span class="number">12</span>,</span><br><span class="line">      Name: <span class="string">&quot;Dokky&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    bs, _ := proto.Marshal(&amp;animal)</span><br><span class="line">    <span class="built_in">println</span>(hex.EncodeToString(bs))</span><br><span class="line">    c.Data(<span class="number">200</span>, <span class="string">&quot;application/x-protobuf&quot;</span>, bs)</span><br><span class="line">  &#125;)</span><br><span class="line">  s.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>server_test.go</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">  <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">  <span class="string">&quot;net/http&quot;</span></span><br><span class="line">  <span class="string">&quot;testing&quot;</span></span><br><span class="line">  <span class="string">&quot;example.com/m/pb&quot;</span></span><br><span class="line">  <span class="string">&quot;google.golang.org/protobuf/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestWhoami</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  request, err := http.NewRequest(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://localhost:8080/whoami&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    t.Error(err)</span><br><span class="line">  &#125;</span><br><span class="line">  request.Header.Add(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-protobuf&quot;</span>)</span><br><span class="line">  response, err := http.DefaultClient.Do(request)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    t.Error(err)</span><br><span class="line">  &#125;</span><br><span class="line">  bs, err := ioutil.ReadAll(response.Body)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    t.Error(err)</span><br><span class="line">  &#125;</span><br><span class="line">  t.Log(hex.EncodeToString(bs))</span><br><span class="line">  whami := &amp;pb.Animal&#123;&#125;</span><br><span class="line">  proto.Unmarshal(bs, whami)</span><br><span class="line">  t.Log(whami)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>運行命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 運行服務端</span></span><br><span class="line">go run server.go</span><br><span class="line"><span class="comment"># 運行測試程序</span></span><br><span class="line">go <span class="built_in">test</span> -test.v server_test.go</span><br><span class="line"><span class="comment"># 或直接通過 curl 訪問</span></span><br><span class="line">curl --header <span class="string">&quot;Content-Type: application/x-protobuf&quot;</span> localhost:8080/whoami</span><br></pre></td></tr></table></figure>

<h4 id="Java-服務端"><a href="#Java-服務端" class="headerlink" title="Java 服務端"></a>Java 服務端</h4><p>Server.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.m.pb.AnimalProto;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpExchange;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpHandler;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpServer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Hex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">HttpServer</span> <span class="variable">server</span> <span class="operator">=</span> HttpServer.create(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">8080</span>), <span class="number">0</span>);</span><br><span class="line">        server.createContext(<span class="string">&quot;/whoami&quot;</span>, <span class="keyword">new</span> <span class="title class_">WhoamiHandler</span>());</span><br><span class="line">        server.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WhoamiHandler</span> <span class="keyword">implements</span> <span class="title class_">HttpHandler</span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            List&lt;String&gt; contentTypes = exchange.getRequestHeaders().get(<span class="string">&quot;Content-Type&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (contentTypes==<span class="literal">null</span> || (contentTypes.size()&gt;<span class="number">0</span> &amp;&amp; !contentTypes.get(<span class="number">0</span>).equals(<span class="string">&quot;application/x-protobuf&quot;</span>)))&#123;</span><br><span class="line">                exchange.sendResponseHeaders(<span class="number">404</span>,<span class="number">0</span>);</span><br><span class="line">                exchange.close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> exchange.getResponseBody();</span><br><span class="line">            AnimalProto.<span class="type">Animal</span> <span class="variable">animal</span>  <span class="operator">=</span> AnimalProto.Animal.newBuilder().setId(<span class="number">12</span>).setName(<span class="string">&quot;Dokky&quot;</span>).build();</span><br><span class="line">            <span class="type">byte</span>[] bs = animal.toByteArray();</span><br><span class="line">            System.out.println(Hex.encodeHexString(bs));</span><br><span class="line">            exchange.sendResponseHeaders(<span class="number">200</span>, bs.length);</span><br><span class="line">            outputStream.write(bs);</span><br><span class="line">            outputStream.flush();</span><br><span class="line">            outputStream.close();</span><br><span class="line">            exchange.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServerTest.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.m.pb.AnimalProto;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Hex;</span><br><span class="line"><span class="keyword">import</span> org.apache.hc.client5.http.classic.methods.HttpGet;</span><br><span class="line"><span class="keyword">import</span> org.apache.hc.client5.http.impl.classic.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.hc.client5.http.impl.classic.CloseableHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.hc.client5.http.impl.classic.HttpClients;</span><br><span class="line"><span class="keyword">import</span> org.apache.hc.core5.http.io.entity.EntityUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> sun.misc.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">testServer</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">CloseableHttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClients.createDefault();</span><br><span class="line">        <span class="type">HttpGet</span> <span class="variable">httpGet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(<span class="string">&quot;http://localhost:8080/whoami&quot;</span>);</span><br><span class="line">        httpGet.setHeader(<span class="string">&quot;Content-Type&quot;</span>,<span class="string">&quot;application/x-protobuf&quot;</span>);</span><br><span class="line">        <span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.execute(httpGet);</span><br><span class="line">        <span class="type">byte</span>[] bs = IOUtils.readAllBytes(response.getEntity().getContent());</span><br><span class="line">        System.out.printf(<span class="string">&quot;%d, %s\n&quot;</span>,response.getCode(), Hex.encodeHexString(bs));</span><br><span class="line">        AnimalProto.<span class="type">Animal</span> <span class="variable">animal</span> <span class="operator">=</span> AnimalProto.Animal.parseFrom(bs);</span><br><span class="line">        System.out.printf(<span class="string">&quot;%d, %s\n&quot;</span>, animal.getId(),animal.getName());</span><br><span class="line">        EntityUtils.consume(response.getEntity());</span><br><span class="line">        httpClient.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="閱讀更多"><a href="#閱讀更多" class="headerlink" title="閱讀更多"></a>閱讀更多</h2><ol>
<li><a target="_blank" rel="noopener" href="https://developers.google.cn/protocol-buffers?hl=zh-cn">protobuf 官方文檔</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf">protobuf 代碼倉庫</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.tsunhualim.top/it/common/protobuf-intro/" data-id="cmetwqhk9001knxncer244ya8" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/protobuf/" rel="tag">protobuf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A2%BC%E5%AE%B6/" rel="tag">代碼家</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/it/go/go-tool-pprof/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">
        
          介紹Go程序性能分析工具 pprof
        
      </div>
    </a>
  
  
    <a href="/essay/think-about-me/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">關於我存在的一點思考</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
    <h3 class="widget-title">貼示</h3>
    <div class="widget" style="min-height: 50px;">
        <img src="" height="50px" style="float: left; margin-right: 10px" />
        <div style="font-size:medium; color:palevioletred;padding-top: 4px;">
           <ul>
                
                    <li>
                        *
                        精力善用
                    </li>
                
                    <li>
                        *
                        筆耕不輟，日有所知，月無忘其所能
                    </li>
                
            </ul>
        </div>
    </div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/arch/birds-eye-view-of-ancient-chinese-architecture/">中國古代建築鳥瞰（一）：構架及屋頂</a>
          </li>
        
          <li>
            <a href="/language/min/ngiang-chhe/">五條人新曲《两人相拍跋落溪》歌詞中的「元差」應是「員差」</a>
          </li>
        
          <li>
            <a href="/language/han/another-way-to-write-chinese/">書寫漢語的另一種方式——表音方塊字「補字」的誕生</a>
          </li>
        
          <li>
            <a href="/essay/be-myself/">做一個「不成材」的人</a>
          </li>
        
          <li>
            <a href="/it/python/python-memory/">Python 程序內存管理及OOM問題分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">專輯</h3>
    <div class="widget tagcloud">
      <!-- <a href="/tags/Go/" style="font-size: 16.67px;">Go</a> <a href="/tags/Hello/" style="font-size: 10px;">Hello</a> <a href="/tags/Java/" style="font-size: 13.33px;">Java</a> <a href="/tags/Python/" style="font-size: 11.67px;">Python</a> <a href="/tags/TODO/" style="font-size: 11.67px;">TODO</a> <a href="/tags/Unicode/" style="font-size: 10px;">Unicode</a> <a href="/tags/net/" style="font-size: 10px;">net</a> <a href="/tags/pprof/" style="font-size: 10px;">pprof</a> <a href="/tags/protobuf/" style="font-size: 10px;">protobuf</a> <a href="/tags/%E4%B8%AD%E5%9C%8B%E5%BB%BA%E7%AF%89/" style="font-size: 10px;">中國建築</a> <a href="/tags/%E4%BA%94%E6%A2%9D%E4%BA%BA/" style="font-size: 10px;">五條人</a> <a href="/tags/%E4%BB%A3%E7%A2%BC%E5%AE%B6/" style="font-size: 20px;">代碼家</a> <a href="/tags/%E5%8D%81%E4%BA%8C%E7%94%9F%E8%82%96/" style="font-size: 10px;">十二生肖</a> <a href="/tags/%E5%93%B2%E5%AD%B8/" style="font-size: 11.67px;">哲學</a> <a href="/tags/%E5%B9%B2%E6%94%AF%E7%B4%80%E5%B9%B4%E6%B3%95/" style="font-size: 10px;">干支紀年法</a> <a href="/tags/%E5%BB%BA%E7%AF%89/" style="font-size: 10px;">建築</a> <a href="/tags/%E6%80%9D%E8%80%83/" style="font-size: 10px;">思考</a> <a href="/tags/%E6%88%91%E6%80%9D/" style="font-size: 10px;">我思</a> <a href="/tags/%E6%96%B0%E5%86%A0/" style="font-size: 10px;">新冠</a> <a href="/tags/%E6%96%B0%E6%99%82%E4%BB%A3/" style="font-size: 10px;">新時代</a> <a href="/tags/%E6%97%A5%E6%9C%AC%E8%AA%9E/" style="font-size: 10px;">日本語</a> <a href="/tags/%E6%B5%B7%E8%B1%90%E8%A9%B1/" style="font-size: 10px;">海豐話</a> <a href="/tags/%E6%BC%A2%E8%AA%9E/" style="font-size: 10px;">漢語</a> <a href="/tags/%E6%BD%AE%E5%8A%87/" style="font-size: 10px;">潮劇</a> <a href="/tags/%E6%BD%AE%E5%B7%9E%E8%A9%B1/" style="font-size: 11.67px;">潮州話</a> <a href="/tags/%E7%94%B2%E5%AD%90%E8%A9%B1/" style="font-size: 13.33px;">甲子話</a> <a href="/tags/%E8%81%86%E8%81%BD%E9%9F%B3%E6%A8%82/" style="font-size: 10px;">聆聽音樂</a> <a href="/tags/%E8%A1%A8%E9%9F%B3%E6%96%B9%E5%A1%8A%E5%AD%97/" style="font-size: 10px;">表音方塊字</a> <a href="/tags/%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">設計模式</a> <a href="/tags/%E8%A9%A9%E7%B6%93/" style="font-size: 10px;">詩經</a> <a href="/tags/%E8%BB%9F%E4%BB%B6%E6%9E%B6%E6%A7%8B/" style="font-size: 10px;">軟件架構</a> <a href="/tags/%E8%BC%94%E5%AD%97/" style="font-size: 10px;">輔字</a> <a href="/tags/%E9%81%8A%E8%A8%98/" style="font-size: 11.67px;">遊記</a> <a href="/tags/%E9%96%A9%E5%8D%97%E8%AA%9E/" style="font-size: 15px;">閩南語</a> <a href="/tags/%E9%96%A9%E8%AA%9E%E6%96%87/" style="font-size: 15px;">閩語文</a> <a href="/tags/%E9%9A%A8%E7%AD%86/" style="font-size: 18.33px;">隨筆</a> <a href="/tags/%E9%9B%BB%E5%BD%B1/" style="font-size: 10px;">電影</a> <a href="/tags/%E9%AD%8F%E6%99%89%E9%A2%A8%E6%B5%81/" style="font-size: 11.67px;">魏晉風流</a> -->
      <ul class="classtest-list" itemprop="keywords"><li class="classtest-list-item"><a class="classtest-list-link" href="/tags/%E4%BB%A3%E7%A2%BC%E5%AE%B6/" rel="tag">代碼家</a><span class="classtest-list-count">15</span></li><li class="classtest-list-item"><a class="classtest-list-link" href="/tags/%E9%9A%A8%E7%AD%86/" rel="tag">隨筆</a><span class="classtest-list-count">11</span></li><li class="classtest-list-item"><a class="classtest-list-link" href="/tags/Go/" rel="tag">Go</a><span class="classtest-list-count">8</span></li><li class="classtest-list-item"><a class="classtest-list-link" href="/tags/%E9%96%A9%E8%AA%9E%E6%96%87/" rel="tag">閩語文</a><span class="classtest-list-count">6</span></li><li class="classtest-list-item"><a class="classtest-list-link" href="/tags/%E9%96%A9%E5%8D%97%E8%AA%9E/" rel="tag">閩南語</a><span class="classtest-list-count">6</span></li></ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">二維碼</h3>
    <div class="widget">
        <img src="https://tsunhua.github.io/qrcode.jpg" width="100%" style="max-width: 200px;" />
    </div>
</div>
  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="創用 CC 授權條款"
          style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
      <br />
      Edited by
      <a xmlns:cc="http: //creativecommons.org/ns#" target="_blank" href="https://github.com/tsunhua" property="cc:attributionName"
        rel="cc:attributionURL noopener">Hua
      </a>

      <br>
      Powered by
      <a href="https://github.com/" target="_blank">Github</a>&nbsp;&&nbsp;
      <a href="https://hexo.io/" target="_blank">Hexo</a>
      <br />

    </div>
  </div>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
</footer>
    </div>
    <nav id="mobile-nav">
  
    
      <a class="mobile-nav-link mobile-nav-main" href="/">頭頁</a>
    
  
    
      <a class="mobile-nav-link mobile-nav-main" target="_blank" rel="noopener" href="https://hokkien-writing.github.io/">閩南語書寫</a>
    
  
    
      <a class="mobile-nav-link mobile-nav-main" href="/atom.xml">RSS</a>
    
  
    
      <a class="mobile-nav-link mobile-nav-main" target="_blank" rel="noopener" href="https://github.com/tsunhua">GitHub</a>
    
  
</nav>

    

<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/search.js"></script> 



  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>